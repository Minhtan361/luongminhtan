<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Qu·∫£n l√Ω l∆∞∆°ng - minhtan361</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--primary:#0066ff;--danger:#e03e2d;--muted:#6c757d;--bg:#f5f8ff}
    body{font-family:'Segoe UI', Tahoma, sans-serif;background:var(--bg);padding-bottom:90px}
    .app-header{background:linear-gradient(90deg,var(--primary),#4a8cff);color:#fff;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 3px 6px rgba(0,0,0,0.1)}
    .card.custom{border-radius:14px;border:0;box-shadow:0 4px 14px rgba(0,0,0,0.08)}
    .upload-area{background:#fff;border:2px dashed #ccd6eb;padding:20px;border-radius:10px;cursor:pointer;transition:all .2s}
    .upload-area.dragover{border-color:var(--primary);background:#eef5ff}
    .red-text{color:var(--danger);font-weight:700}
    .badge-shift{background:#eaf2ff;color:var(--primary);padding:4px 8px;border-radius:6px;font-weight:600}
    .table-hover tbody tr:hover{background:#f6faff}
    footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #ddd;padding:10px 14px;text-align:center}
    .editable{cursor:pointer;background:#fff3cd}
    .emp-list{max-height:200px;overflow-y:auto;border:1px solid #ddd;padding:8px;border-radius:6px;background:#fff}
    .emp-item{margin-bottom:4px}
    .holiday-item{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .saved-data-info {font-size: 12px; color: var(--muted); margin-top: 5px;}
    @media print{ body{background:#fff;padding:0} .no-print{display:none!important} .print-area{display:block} .print-card{border:1px solid #000;padding:20px;border-radius:10px} }
  </style>
</head>
<body>
  <div class="container mt-3">
    <div class="app-header d-flex justify-content-between no-print">
      <h5 class="mb-0">Qu·∫£n l√Ω t√≠nh l∆∞∆°ng t·ª´ ch·∫•m c√¥ng</h5>
      <span>minhtan361</span>
    </div>

    <div class="row g-3 no-print">
      <div class="col-lg-8">
        <div class="card custom p-3 mb-3">
          <div class="d-flex gap-3">
            <div class="flex-grow-1">
              <div id="uploadArea" class="upload-area text-center">
                <div style="font-size:26px;color:var(--primary)">üìÅ</div>
                <div><strong>Ch·ªçn file Excel ch·∫•m c√¥ng</strong></div>
                <div class="saved-data-info" id="savedDataInfo"></div>
                <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="d-none">
              </div>
              <div id="fileInfo" class="mt-2 d-none alert alert-info p-2"></div>
            </div>

            <div style="width:320px">
              <label class="form-label">Ch·ªçn nh√¢n vi√™n</label>
              <div id="employeeList" class="emp-list"></div>
              <label class="form-label mt-2">Kho·∫£ng ng√†y</label>
              <div class="d-flex gap-2 mb-2">
                <input id="fromDate" type="date" class="form-control">
                <input id="toDate" type="date" class="form-control">
              </div>
              <div class="d-flex gap-2">
                <button id="filterBtn" class="btn btn-primary w-100" disabled>√Åp d·ª•ng</button>
                <button id="resetRange" class="btn btn-outline-primary" disabled>Reset</button>
                <button id="clearDataBtn" class="btn btn-outline-danger">X√≥a d·ªØ li·ªáu</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card custom p-3">
          <div class="d-flex justify-content-between mb-2">
            <h6>D·ªØ li·ªáu ch·∫•m c√¥ng: <span id="selectedEmployee">Ch∆∞a ch·ªçn</span></h6>
            <div class="d-flex gap-2">
              <button id="exportBtn" class="btn btn-success btn-sm" disabled>Xu·∫•t Excel</button>
              <button id="printBtn" class="btn btn-outline-secondary btn-sm" disabled>In phi·∫øu l∆∞∆°ng</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table table-bordered table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>T√™n</th>
                  <th>Ng√†y</th>
                  <th>Ch·ª©c v·ª•</th>
                  <th>Gi·ªù v√†o</th>
                  <th>Gi·ªù ra</th>
                  <th>Gi·ªù l√†m</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="attendanceTable">
                <tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card custom p-3 mb-3">
          <h6>C·∫≠p nh·∫≠t th√¥ng tin t√≠nh l∆∞∆°ng</h6>
          <label class="form-label">L∆∞∆°ng theo gi·ªù</label>
          <input id="hourlySalary" type="number" class="form-control mb-2" value="25000">
          <label class="form-label">Th∆∞·ªüng</label>
          <input id="bonus" type="number" class="form-control mb-2" value="0">
          <label class="form-label">Ph·∫°t kh√°c</label>
          <input id="penalty" type="number" class="form-control mb-2" value="0">
          <label class="form-label">Ph·∫°t qu√™n ch·∫•m ra (m·ªói l·∫ßn)</label>
          <input id="missingPenaltyPer" type="number" class="form-control mb-2" value="20000">
          <label class="form-label">Ph·∫°t s·ª≠a c√¥ng (ph·∫°t ch·∫•m c√¥ng) (m·ªói l·∫ßn)</label>
          <input id="editPenaltyPer" type="number" class="form-control mb-2" value="20000">

          <hr>
          <h6>Danh s√°ch ng√†y l·ªÖ (ƒë·ªÉ nh√¢n ƒë√¥i l∆∞∆°ng trong ng√†y ƒë√≥)</h6>
          <div class="d-flex gap-2 mb-2">
            <input id="holidayDate" type="date" class="form-control">
            <button id="addHoliday" class="btn btn-outline-primary">Th√™m</button>
          </div>
          <div id="holidayList" style="max-height:120px;overflow:auto;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd"></div>

          <button id="calculateBtn" class="btn btn-primary w-100 mt-3">C·∫≠p nh·∫≠t t√≠nh to√°n</button>
        </div>

        <div class="card custom p-3 print-area">
          <h6>Th√¥ng tin ch·∫•m c√¥ng</h6>
          <div>L∆∞∆°ng theo gi·ªù: <strong id="infoHourly">0</strong></div>
          <div>T·ªïng ng√†y c√¥ng: <strong id="totalDays">0</strong></div>
          <div>T·ªïng gi·ªù l√†m: <strong id="totalHours">0 gi·ªù 0 ph√∫t</strong></div>
          <div>T·ªïng l·∫ßn s·ª≠a c√¥ng: <strong id="totalEdited">0</strong></div>
          <hr>
          <h6>Chi ti·∫øt l∆∞∆°ng</h6>
          <div class="d-flex justify-content-between"><span>L∆∞∆°ng theo gi·ªù (t√≠nh t·ª´ gi·ªù l√†m)</span><span id="salaryHourly">0</span></div>
          <div class="d-flex justify-content-between"><span>Ph·∫ßn l∆∞∆°ng ng√†y l·ªÖ (ƒë√£ t√≠nh nh√¢n ƒë√¥i)</span><span id="salaryHoliday">0</span></div>
          <div class="d-flex justify-content-between"><span>Th∆∞·ªüng</span><span id="salaryBonus">0</span></div>
          <div class="d-flex justify-content-between"><span>Ph·∫°t s·ª≠a c√¥ng</span><span id="salaryEditPenalty">0</span></div>
          <div class="d-flex justify-content-between"><span>Ph·∫°t qu√™n ch·∫•m</span><span id="salaryMissingPenalty">0</span></div>
          <div class="d-flex justify-content-between"><span>Ph·∫°t kh√°c</span><span id="salaryPenalty">0</span></div>
          <hr>
          <div class="d-flex justify-content-between"><strong>T·ªïng th·ª±c nh·∫≠n</strong><strong id="salaryTotal">0</strong></div>
          <hr>
          <div id="holidayDetail" style="font-size:13px;color:var(--muted)"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="no-print">¬© minhtan361</footer>

<script>
// Bi·∫øn to√†n c·ª•c
let allAttendanceData = [], employees = [], currentEmployee = null, filteredData = [];
let holidays = []; // array of yyyy-mm-dd strings

// Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ localStorage n·∫øu c√≥
function initFromLocalStorage() {
  try {
    const savedData = localStorage.getItem('attendanceData');
    const savedHolidays = localStorage.getItem('holidays');
    const savedSettings = localStorage.getItem('salarySettings');
    
    if (savedData) {
      const parsedData = JSON.parse(savedData);
      allAttendanceData = parsedData.map(item => ({
        ...item,
        date: new Date(item.date)
      }));
      
      employees = [...new Set(allAttendanceData.map(item => item.name))];
      updateEmployeeList();
      document.getElementById('savedDataInfo').textContent = `ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ l·∫ßn l√†m vi·ªác tr∆∞·ªõc (${allAttendanceData.length} b·∫£n ghi)`;
    }
    
    if (savedHolidays) {
      holidays = JSON.parse(savedHolidays);
      renderHolidayList();
    }
    
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      document.getElementById('hourlySalary').value = settings.hourlySalary || 25000;
      document.getElementById('bonus').value = settings.bonus || 0;
      document.getElementById('penalty').value = settings.penalty || 0;
      document.getElementById('missingPenaltyPer').value = settings.missingPenaltyPer || 20000;
      document.getElementById('editPenaltyPer').value = settings.editPenaltyPer || 20000;
    }
  } catch (e) {
    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ localStorage:', e);
  }
}

// L∆∞u d·ªØ li·ªáu v√†o localStorage
function saveToLocalStorage() {
  try {
    // L∆∞u d·ªØ li·ªáu ch·∫•m c√¥ng (chuy·ªÉn Date th√†nh chu·ªói)
    const dataToSave = allAttendanceData.map(item => ({
      ...item,
      date: item.date.toISOString()
    }));
    localStorage.setItem('attendanceData', JSON.stringify(dataToSave));
    
    // L∆∞u ng√†y l·ªÖ
    localStorage.setItem('holidays', JSON.stringify(holidays));
    
    // L∆∞u c√†i ƒë·∫∑t l∆∞∆°ng
    const settings = {
      hourlySalary: parseInt(document.getElementById('hourlySalary').value),
      bonus: parseInt(document.getElementById('bonus').value),
      penalty: parseInt(document.getElementById('penalty').value),
      missingPenaltyPer: parseInt(document.getElementById('missingPenaltyPer').value),
      editPenaltyPer: parseInt(document.getElementById('editPenaltyPer').value)
    };
    localStorage.setItem('salarySettings', JSON.stringify(settings));
  } catch (e) {
    console.error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o localStorage:', e);
  }
}

function formatCurrency(n) { return n.toLocaleString('vi-VN'); }
function toDateKey(d){ 
  if(!(d instanceof Date)) return null; 
  const y = d.getFullYear();
  const m = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}

function timeToMinutes(t) {
  if (!t || typeof t !== 'string') return null;
  // X·ª≠ l√Ω c·∫£ tr∆∞·ªùng h·ª£p c√≥ gi√¢y
  let parts = t.split(':').map(Number);
  if (parts.length < 2 || isNaN(parts[0]) || isNaN(parts[1])) return null;
  return parts[0] * 60 + parts[1];
}

function minutesToTimeStr(m) {
  if (m === null || m === undefined) return '-';
  let hours = Math.floor(m / 60);
  let minutes = m % 60;
  return hours + ' gi·ªù ' + minutes + ' ph√∫t';
}

function calculateWorkMinutes(checkIn, checkOut) {
  if (!checkIn || !checkOut || checkIn === 'Ch∆∞a ch·∫•m ra' || checkOut === 'Ch∆∞a ch·∫•m ra') return 0;
  
  let [hIn, mIn] = checkIn.split(':').map(Number);
  let [hOut, mOut] = checkOut.split(':').map(Number);
  let inMinutes = hIn * 60 + mIn;
  let outMinutes = hOut * 60 + mOut;
  let workMinutes = outMinutes - inMinutes;
  if (workMinutes < 0) workMinutes += 24 * 60;
  return workMinutes;
}

// DOM elements
const fileInput = document.getElementById('fileInput');
const uploadArea = document.getElementById('uploadArea');
const fileInfo = document.getElementById('fileInfo');
const empListDiv = document.getElementById('employeeList');
const attendanceTable = document.getElementById('attendanceTable');
const selectedEmployee = document.getElementById('selectedEmployee');
const filterBtn = document.getElementById('filterBtn');
const resetRange = document.getElementById('resetRange');
const clearDataBtn = document.getElementById('clearDataBtn');
const fromDateEl = document.getElementById('fromDate');
const toDateEl = document.getElementById('toDate');
const exportBtn = document.getElementById('exportBtn');
const printBtn = document.getElementById('printBtn');
const calculateBtn = document.getElementById('calculateBtn');
const holidayDateEl = document.getElementById('holidayDate');
const addHolidayBtn = document.getElementById('addHoliday');
const holidayListDiv = document.getElementById('holidayList');

// Kh·ªüi t·∫°o d·ªØ li·ªáu t·ª´ localStorage khi trang ƒë∆∞·ª£c t·∫£i
document.addEventListener('DOMContentLoaded', function() {
  initFromLocalStorage();
  
  // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh cho kho·∫£ng th·ªùi gian (th√°ng hi·ªán t·∫°i)
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

  fromDateEl.value = firstDay.toISOString().slice(0, 10);
  toDateEl.value = lastDay.toISOString().slice(0, 10);
  holidayDateEl.value = today.toISOString().slice(0, 10);
});

uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => { 
  if (fileInput.files.length) handleFile(fileInput.files[0]); 
});

['dragenter', 'dragover'].forEach(evt => {
  uploadArea.addEventListener(evt, e => { 
    e.preventDefault(); 
    uploadArea.classList.add('dragover'); 
  });
});

['dragleave', 'drop'].forEach(evt => {
  uploadArea.addEventListener(evt, e => { 
    e.preventDefault(); 
    uploadArea.classList.remove('dragover'); 
  });
});

uploadArea.addEventListener('drop', e => { 
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); 
});

clearDataBtn.addEventListener('click', () => {
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
    localStorage.removeItem('attendanceData');
    localStorage.removeItem('holidays');
    localStorage.removeItem('salarySettings');
    allAttendanceData = [];
    employees = [];
    currentEmployee = null;
    filteredData = [];
    holidays = [];
    empListDiv.innerHTML = '';
    attendanceTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
    selectedEmployee.textContent = 'Ch∆∞a ch·ªçn';
    document.getElementById('savedDataInfo').textContent = '';
    filterBtn.disabled = true;
    resetRange.disabled = true;
    exportBtn.disabled = true;
    printBtn.disabled = true;
    alert('ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu');
  }
});

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    processExcel(raw);
    fileInfo.classList.remove('d-none');
    fileInfo.innerHTML = `<strong>File:</strong> ${file.name} | <strong>K√≠ch th∆∞·ªõc:</strong> ${(file.size/1024).toFixed(1)} KB`;
  };
  reader.readAsArrayBuffer(file);
}

function processExcel(rows) {
  allAttendanceData = [];
  employees = [];
  
  // T√¨m h√†ng ti√™u ƒë·ªÅ
  let headerRowIndex = -1;
  for (let i = 0; i < rows.length; i++) {
    if (rows[i] && rows[i].some(cell => cell && typeof cell === 'string' && 
        (cell.toLowerCase().includes('ng√†y') || cell.toLowerCase().includes('nh√¢n vi√™n')))) {
      headerRowIndex = i;
      break;
    }
  }
  
  if (headerRowIndex === -1) {
    alert('Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ trong file Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.');
    return;
  }
  
  const headers = rows[headerRowIndex].map(h => h ? h.toLowerCase().trim() : '');
  const dateIndex = headers.findIndex(h => h.includes('ng√†y'));
  const nameIndex = headers.findIndex(h => h.includes('nh√¢n vi√™n'));
  const positionIndex = headers.findIndex(h => h.includes('ch·ª©c v·ª•'));
  const checkInIndex = headers.findIndex(h => h.includes('gi·ªù v√†o'));
  const checkOutIndex = headers.findIndex(h => h.includes('gi·ªù ra'));
  
  if (dateIndex === -1 || nameIndex === -1) {
    alert('File Excel kh√¥ng c√≥ c·ªôt Ng√†y ho·∫∑c Nh√¢n vi√™n. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.');
    return;
  }
  
  // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ c√°c h√†ng
  for (let i = headerRowIndex + 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || row.length < Math.max(dateIndex, nameIndex, checkInIndex, checkOutIndex) + 1) continue;
    
    const dateStr = row[dateIndex];
    const name = row[nameIndex];
    const position = positionIndex !== -1 ? row[positionIndex] : '';
    const checkIn = checkInIndex !== -1 ? row[checkInIndex] : '';
    const checkOut = checkOutIndex !== -1 ? row[checkOutIndex] : '';
    
    if (!dateStr || !name) continue;
    
    // Chuy·ªÉn ƒë·ªïi ng√†y th√°ng
    let date;
    if (typeof dateStr === 'string' && dateStr.includes('/')) {
      const [day, month, year] = dateStr.split('/').map(Number);
      date = new Date(year, month - 1, day);
    } else if (dateStr instanceof Date) {
      date = dateStr;
    } else {
      // Th·ª≠ chuy·ªÉn ƒë·ªïi s·ªë serial Excel th√†nh ng√†y
      date = new Date((dateStr - 25569) * 86400 * 1000);
    }
    
    if (isNaN(date.getTime())) {
      console.warn('Ng√†y kh√¥ng h·ª£p l·ªá:', dateStr);
      continue;
    }
    
    allAttendanceData.push({
      date,
      name: name.toString().trim(),
      position: position ? position.toString().trim() : '',
      rawCheckIn: checkIn ? checkIn.toString().trim() : '',
      rawCheckOut: checkOut ? checkOut.toString().trim() : '',
      edited: false
    });
    
    if (!employees.includes(name.toString().trim())) {
      employees.push(name.toString().trim());
    }
  }
  
  // L∆∞u d·ªØ li·ªáu v√†o localStorage
  saveToLocalStorage();
  
  // C·∫≠p nh·∫≠t giao di·ªán
  updateEmployeeList();
  filterBtn.disabled = false;
  resetRange.disabled = false;
  
  alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${allAttendanceData.length} b·∫£n ghi ch·∫•m c√¥ng t·ª´ ${employees.length} nh√¢n vi√™n`);
}

function updateEmployeeList() {
  empListDiv.innerHTML = '';
  
  if (employees.length === 0) {
    empListDiv.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu nh√¢n vi√™n</div>';
    return;
  }
  
  employees.forEach(emp => {
    const div = document.createElement('div');
    div.className = 'form-check emp-item';
    div.innerHTML = `
      <input class="form-check-input emp-radio" type="radio" name="employeeRadio" id="emp-${emp}" value="${emp}">
      <label class="form-check-label" for="emp-${emp}">${emp}</label>
    `;
    empListDiv.appendChild(div);
  });
  
  // Th√™m s·ª± ki·ªán khi ch·ªçn nh√¢n vi√™n
  document.querySelectorAll('.emp-radio').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.checked) {
        currentEmployee = e.target.value;
        selectedEmployee.textContent = currentEmployee;
        applyFilter();
      }
    });
  });
}

function applyFilter() {
  if (!currentEmployee) return;
  
  filteredData = allAttendanceData.filter(item => item.name === currentEmployee);
  
  const fromDate = fromDateEl.value ? new Date(fromDateEl.value) : null;
  const toDate = toDateEl.value ? new Date(toDateEl.value) : null;
  
  if (fromDate && toDate) {
    filteredData = filteredData.filter(item => {
      const itemDate = item.date;
      return itemDate >= fromDate && itemDate <= toDate;
    });
  }
  
  renderTable();
  calculateSalary();
}

function renderTable() {
  attendanceTable.innerHTML = '';
  
  if (filteredData.length === 0) {
    attendanceTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    return;
  }
  
  filteredData.forEach((item, idx) => {
    const workMinutes = calculateWorkMinutes(item.rawCheckIn, item.rawCheckOut);
    const isMissing = !item.rawCheckOut || item.rawCheckOut === 'Ch∆∞a ch·∫•m ra';
    
    let status = '';
    if (item.edited) {
      status = '<span class="badge badge-shift red-text">ƒê√£ s·ª≠a</span>';
    } else if (isMissing) {
      status = '<span class="badge badge-shift red-text">Ch∆∞a ch·∫•m ra</span>';
    } else {
      status = '<span class="badge badge-shift">ƒê√£ ch·∫•m</span>';
    }
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.date.toLocaleDateString('vi-VN')}</td>
      <td>${item.position}</td>
      <td class="editable" data-idx="${idx}" data-field="in">${item.rawCheckIn || '-'}</td>
      <td class="editable" data-idx="${idx}" data-field="out">${item.rawCheckOut || '-'}</td>
      <td>${minutesToTimeStr(workMinutes)}</td>
      <td>${status}</td>
    `;
    attendanceTable.appendChild(tr);
  });
  
  exportBtn.disabled = false;
  printBtn.disabled = false;
}

// Cho ph√©p ch·ªânh s·ª≠a gi·ªù ch·∫•m c√¥ng
attendanceTable.addEventListener('click', e => {
  if (e.target.classList.contains('editable')) {
    const td = e.target;
    const oldValue = td.textContent;
    const idx = td.getAttribute('data-idx');
    const field = td.getAttribute('data-field');
    
    const newValue = prompt('Nh·∫≠p l·∫°i gi·ªù (HH:MM):', oldValue === '-' ? '' : oldValue);
    if (newValue !== null && newValue !== '') {
      if (field === 'in') {
        filteredData[idx].rawCheckIn = newValue;
      } else {
        filteredData[idx].rawCheckOut = newValue;
      }
      filteredData[idx].edited = true;
      
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu g·ªëc
      const originalIdx = allAttendanceData.findIndex(item => 
        item.date.getTime() === filteredData[idx].date.getTime() && 
        item.name === filteredData[idx].name
      );
      
      if (originalIdx !== -1) {
        if (field === 'in') {
          allAttendanceData[originalIdx].rawCheckIn = newValue;
        } else {
          allAttendanceData[originalIdx].rawCheckOut = newValue;
        }
        allAttendanceData[originalIdx].edited = true;
      }
      
      saveToLocalStorage();
      renderTable();
      calculateSalary();
    }
  }
});

// Qu·∫£n l√Ω ng√†y l·ªÖ
addHolidayBtn.addEventListener('click', () => {
  const date = holidayDateEl.value;
  if (!date) return alert('Vui l√≤ng ch·ªçn ng√†y');
  
  if (holidays.includes(date)) {
    alert('Ng√†y n√†y ƒë√£ c√≥ trong danh s√°ch l·ªÖ');
    return;
  }
  
  holidays.push(date);
  holidays.sort();
  saveToLocalStorage();
  renderHolidayList();
  holidayDateEl.value = '';
  
  if (filteredData.length > 0) {
    calculateSalary();
  }
});

function renderHolidayList() {
  holidayListDiv.innerHTML = '';
  
  if (holidays.length === 0) {
    holidayListDiv.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ ng√†y l·ªÖ n√†o</div>';
    return;
  }
  
  holidays.forEach(date => {
    const dateObj = new Date(date);
    const div = document.createElement('div');
    div.className = 'holiday-item';
    div.innerHTML = `
      <span>${dateObj.toLocaleDateString('vi-VN')}</span>
      <button class="btn btn-sm btn-outline-danger remove-holiday" data-date="${date}">X√≥a</button>
    `;
    holidayListDiv.appendChild(div);
  });
  
  // Th√™m s·ª± ki·ªán x√≥a ng√†y l·ªÖ
  document.querySelectorAll('.remove-holiday').forEach(btn => {
    btn.addEventListener('click', e => {
      const dateToRemove = e.target.getAttribute('data-date');
      holidays = holidays.filter(d => d !== dateToRemove);
      saveToLocalStorage();
      renderHolidayList();
      
      if (filteredData.length > 0) {
        calculateSalary();
      }
    });
  });
}

function calculateSalary() {
  if (filteredData.length === 0) return;
  
  const hourlySalary = parseInt(document.getElementById('hourlySalary').value);
  const bonus = parseInt(document.getElementById('bonus').value);
  const penalty = parseInt(document.getElementById('penalty').value);
  const missingPenaltyPer = parseInt(document.getElementById('missingPenaltyPer').value);
  const editPenaltyPer = parseInt(document.getElementById('editPenaltyPer').value);
  
  let totalMinutes = 0;
  let totalDays = 0;
  let totalMissing = 0;
  let totalEdited = 0;
  let holidayMinutes = 0;
  let holidayDetails = [];
  
  filteredData.forEach(item => {
    const workMinutes = calculateWorkMinutes(item.rawCheckIn, item.rawCheckOut);
    const isMissing = !item.rawCheckOut || item.rawCheckOut === 'Ch∆∞a ch·∫•m ra';
    const dateKey = toDateKey(item.date);
    const isHoliday = holidays.includes(dateKey);
    
    if (workMinutes > 0) {
      totalMinutes += workMinutes;
      totalDays++;
      
      if (isHoliday) {
        holidayMinutes += workMinutes;
        holidayDetails.push({
          date: item.date.toLocaleDateString('vi-VN'),
          minutes: workMinutes
        });
      }
    }
    
    if (isMissing) totalMissing++;
    if (item.edited) totalEdited++;
  });
  
  const totalHours = Math.floor(totalMinutes / 60);
  const remainingMinutes = totalMinutes % 60;
  
  const baseSalary = Math.round(totalMinutes / 60 * hourlySalary);
  const holidayBonus = Math.round(holidayMinutes / 60 * hourlySalary); // T√≠nh th√™m ti·ªÅn ng√†y l·ªÖ
  const missingPenalty = totalMissing * missingPenaltyPer;
  const editPenalty = totalEdited * editPenaltyPer;
  
  const totalSalary = baseSalary + holidayBonus + bonus - penalty - missingPenalty - editPenalty;
  
  // C·∫≠p nh·∫≠t giao di·ªán
  document.getElementById('infoHourly').textContent = formatCurrency(hourlySalary);
  document.getElementById('totalDays').textContent = totalDays;
  document.getElementById('totalHours').textContent = `${totalHours} gi·ªù ${remainingMinutes} ph√∫t`;
  document.getElementById('totalEdited').textContent = totalEdited;
  
  document.getElementById('salaryHourly').textContent = formatCurrency(baseSalary);
  document.getElementById('salaryHoliday').textContent = formatCurrency(holidayBonus);
  document.getElementById('salaryBonus').textContent = formatCurrency(bonus);
  document.getElementById('salaryEditPenalty').textContent = `-${formatCurrency(editPenalty)}`;
  document.getElementById('salaryMissingPenalty').textContent = `-${formatCurrency(missingPenalty)}`;
  document.getElementById('salaryPenalty').textContent = `-${formatCurrency(penalty)}`;
  document.getElementById('salaryTotal').textContent = formatCurrency(totalSalary);
  
  // Hi·ªÉn th·ªã chi ti·∫øt ng√†y l·ªÖ
  let holidayDetailHTML = '';
  if (holidayDetails.length > 0) {
    holidayDetailHTML = 'Ng√†y l·ªÖ: ';
    holidayDetails.forEach(detail => {
      holidayDetailHTML += `${detail.date} (${Math.floor(detail.minutes/60)}h${detail.minutes%60}p), `;
    });
    holidayDetailHTML = holidayDetailHTML.slice(0, -2); // X√≥a d·∫•u ph·∫©y cu·ªëi
  } else {
    holidayDetailHTML = 'Kh√¥ng c√≥ ng√†y l·ªÖ trong kho·∫£ng th·ªùi gian n√†y';
  }
  document.getElementById('holidayDetail').textContent = holidayDetailHTML;
  
  // L∆∞u c√†i ƒë·∫∑t
  saveToLocalStorage();
}

// G√°n s·ª± ki·ªán
filterBtn.addEventListener('click', applyFilter);
resetRange.addEventListener('click', () => {
  fromDateEl.value = '';
  toDateEl.value = '';
  applyFilter();
});
calculateBtn.addEventListener('click', calculateSalary);

// Xu·∫•t Excel
exportBtn.addEventListener('click', () => {
  if (filteredData.length === 0) {
    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
    return;
  }
  
  const hourlySalary = parseInt(document.getElementById('hourlySalary').value);
  const bonus = parseInt(document.getElementById('bonus').value);
  const penalty = parseInt(document.getElementById('penalty').value);
  const missingPenaltyPer = parseInt(document.getElementById('missingPenaltyPer').value);
  const editPenaltyPer = parseInt(document.getElementById('editPenaltyPer').value);
  
  let totalMinutes = 0;
  let totalMissing = 0;
  let totalEdited = 0;
  let holidayMinutes = 0;
  
  const dataForExport = [
    ['B·∫¢NG CH·∫§M C√îNG V√Ä T√çNH L∆Ø∆†NG'],
    ['Nh√¢n vi√™n:', currentEmployee],
    [''],
    ['Ng√†y', 'Ch·ª©c v·ª•', 'Gi·ªù v√†o', 'Gi·ªù ra', 'Th·ªùi gian l√†m', 'Tr·∫°ng th√°i', 'L∆∞∆°ng (VND)']
  ];
  
  filteredData.forEach(item => {
    const workMinutes = calculateWorkMinutes(item.rawCheckIn, item.rawCheckOut);
    const isMissing = !item.rawCheckOut || item.rawCheckOut === 'Ch∆∞a ch·∫•m ra';
    const dateKey = toDateKey(item.date);
    const isHoliday = holidays.includes(dateKey);
    
    let status = '';
    if (item.edited) {
      status = 'ƒê√£ s·ª≠a';
    } else if (isMissing) {
      status = 'Ch∆∞a ch·∫•m ra';
    } else {
      status = 'ƒê√£ ch·∫•m';
    }
    
    let salary = 0;
    if (workMinutes > 0) {
      totalMinutes += workMinutes;
      salary = Math.round(workMinutes / 60 * hourlySalary);
      
      if (isHoliday) {
        holidayMinutes += workMinutes;
        salary += Math.round(workMinutes / 60 * hourlySalary); // Nh√¢n ƒë√¥i cho ng√†y l·ªÖ
      }
    }
    
    if (isMissing) totalMissing++;
    if (item.edited) totalEdited++;
    
    dataForExport.push([
      item.date.toLocaleDateString('vi-VN'),
      item.position,
      item.rawCheckIn || '-',
      item.rawCheckOut || '-',
      minutesToTimeStr(workMinutes),
      status,
      formatCurrency(salary)
    ]);
  });
  
  const baseSalary = Math.round(totalMinutes / 60 * hourlySalary);
  const holidayBonus = Math.round(holidayMinutes / 60 * hourlySalary);
  const missingPenalty = totalMissing * missingPenaltyPer;
  const editPenalty = totalEdited * editPenaltyPer;
  const totalSalary = baseSalary + holidayBonus + bonus - penalty - missingPenalty - editPenalty;
  
  dataForExport.push(['']);
  dataForExport.push(['T·ªîNG H·ª¢P L∆Ø∆†NG']);
  dataForExport.push(['L∆∞∆°ng c∆° b·∫£n:', formatCurrency(baseSalary)]);
  dataForExport.push(['Ph·ª• c·∫•p ng√†y l·ªÖ:', formatCurrency(holidayBonus)]);
  dataForExport.push(['Th∆∞·ªüng:', formatCurrency(bonus)]);
  dataForExport.push(['Ph·∫°t s·ª≠a c√¥ng:', `-${formatCurrency(editPenalty)}`]);
  dataForExport.push(['Ph·∫°t qu√™n ch·∫•m:', `-${formatCurrency(missingPenalty)}`]);
  dataForExport.push(['Ph·∫°t kh√°c:', `-${formatCurrency(penalty)}`]);
  dataForExport.push(['T·ªîNG TH·ª∞C NH·∫¨N:', formatCurrency(totalSalary)]);
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dataForExport);
  XLSX.utils.book_append_sheet(wb, ws, 'B·∫£ng l∆∞∆°ng');
  XLSX.writeFile(wb, `Bang_luong_${currentEmployee}_${new Date().toISOString().slice(0,10)}.xlsx`);
});

// In phi·∫øu l∆∞∆°ng
printBtn.addEventListener('click', () => {
  if (!currentEmployee || filteredData.length === 0) {
    alert("Vui l√≤ng ch·ªçn nh√¢n vi√™n v√† c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng tr∆∞·ªõc khi in");
    return;
  }

  const hourlySalary = parseInt(document.getElementById('hourlySalary').value);
  const bonus = parseInt(document.getElementById('bonus').value);
  const penalty = parseInt(document.getElementById('penalty').value);
  const missingPenaltyPer = parseInt(document.getElementById('missingPenaltyPer').value);
  const editPenaltyPer = parseInt(document.getElementById('editPenaltyPer').value);

  let totalMinutes = 0;
  let totalDays = 0;
  let totalMissing = 0;
  let totalEdited = 0;
  let holidayMinutes = 0;
  let holidayDetails = [];

  filteredData.forEach(item => {
    const workMinutes = calculateWorkMinutes(item.rawCheckIn, item.rawCheckOut);
    const isMissing = !item.rawCheckOut || item.rawCheckOut === 'Ch∆∞a ch·∫•m ra';
    const dateKey = toDateKey(item.date);
    const isHoliday = holidays.includes(dateKey);

    if (workMinutes > 0) {
      totalMinutes += workMinutes;
      totalDays++;

      if (isHoliday) {
        holidayMinutes += workMinutes;
        holidayDetails.push({
          date: dateKey,
          minutes: workMinutes
        });
      }
    }

    if (isMissing) totalMissing++;
    if (item.edited) totalEdited++;
  });

  const totalHours = Math.floor(totalMinutes / 60);
  const remainingMinutes = totalMinutes % 60;

  const baseSalary = Math.round(totalMinutes / 60 * hourlySalary);
  const holidayBonus = Math.round(holidayMinutes / 60 * hourlySalary);
  const missingPenalty = totalMissing * missingPenaltyPer;
  const editPenalty = totalEdited * editPenaltyPer;

  const totalSalary = baseSalary + holidayBonus + bonus - penalty - missingPenalty - editPenalty;

  // T·∫°o c·ª≠a s·ªï in
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Phi·∫øu l∆∞∆°ng - ${currentEmployee}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .print-header { background: #0066ff; color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
          .print-section { margin-bottom: 15px; }
          .print-detail { display: flex; justify-content: space-between; margin-bottom: 5px; }
          .print-total { font-weight: bold; font-size: 18px; border-top: 2px solid #000; padding-top: 10px; margin-top: 10px; }
          .print-holiday-detail { font-size: 14px; color: #666; margin-top: 10px; }
          @media print {
            body { margin: 0; padding: 15px; }
            .print-header { background: #0066ff !important; -webkit-print-color-adjust: exact; }
          }
        </style>
      </head>
      <body>
        <div class="print-header">
          <h2>Phi·∫øu l∆∞∆°ng - ${currentEmployee}</h2>
        </div>
        
        <div class="print-section">
          <h3>Th√¥ng tin ch·∫•m c√¥ng</h3>
          <div class="print-detail"><span>L∆∞∆°ng theo gi·ªù:</span> <span>${formatCurrency(hourlySalary)} / gi·ªù</span></div>
          <div class="print-detail"><span>T·ªïng ng√†y c√¥ng:</span> <span>${totalDays}</span></div>
          <div class="print-detail"><span>T·ªïng gi·ªù l√†m:</span> <span>${totalHours} gi·ªù ${remainingMinutes} ph√∫t</span></div>
          <div class="print-detail"><span>T·ªïng l·∫ßn s·ª≠a c√¥ng:</span> <span>${totalEdited}</span></div>
        </div>
        
        <div class="print-section">
          <h3>Chi ti·∫øt l∆∞∆°ng</h3>
          <div class="print-detail"><span>L∆∞∆°ng theo gi·ªù (t·ª´ gi·ªù l√†m):</span> <span>${formatCurrency(baseSalary)}</span></div>
          <div class="print-detail"><span>Ph·∫ßn l∆∞∆°ng ng√†y l·ªÖ (ƒë√£ t√≠nh nh√¢n ƒë√¥i):</span> <span>+${formatCurrency(holidayBonus)}</span></div>
          <div class="print-detail"><span>Th∆∞·ªüng:</span> <span>${formatCurrency(bonus)}</span></div>
          <div class="print-detail"><span>Ph·∫°t s·ª≠a c√¥ng:</span> <span>-${formatCurrency(editPenalty)}</span></div>
          <div class="print-detail"><span>Ph·∫°t qu√™n ch·∫•m:</span> <span>-${formatCurrency(missingPenalty)}</span></div>
          <div class="print-detail"><span>Ph·∫°t kh√°c:</span> <span>-${formatCurrency(penalty)}</span></div>
          <div class="print-total"><span>T·ªïng th·ª±c nh·∫≠n:</span> <span>${formatCurrency(totalSalary)}</span></div>
        </div>
        
        <div class="print-section">
          <h3>Chi ti·∫øt ng√†y l·ªÖ</h3>
          <div class="print-holiday-detail">
            ${holidays.length > 0 ? 
              `Ng√†y l·ªÖ ƒë∆∞·ª£c ch·ªçn: ${holidays.join(', ')}<br>` : 
              'Kh√¥ng c√≥ ng√†y l·ªÖ trong kho·∫£ng th·ªùi gian n√†y'
            }
            ${holidayDetails.map(detail => {
              const hours = Math.floor(detail.minutes / 60);
              const minutes = detail.minutes % 60;
              const basePay = Math.round(detail.minutes / 60 * hourlySalary);
              return `${detail.date} - L√†m ${hours} gi·ªù ${minutes} ph√∫t ‚Üí ti·ªÅn c∆° b·∫£n: ${formatCurrency(basePay)} ‚Üí tƒÉng th√™m: ${formatCurrency(basePay)}`;
            }).join('<br>')}
          </div>
        </div>
        
        <script>
          window.onload = function() {
            window.print();
          };
        <\/script>
      </body>
    </html>
  `);
  printWindow.document.close();

});
</script>
</body>
</html>